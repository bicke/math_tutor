<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>さくら先生の個別カリキュラム学習システム</title>
    <style>
        /* 既存のCSSに追加 */
        .curriculum-setup {
            background: linear-gradient(135deg, #e8f5e8, #f1f8e9);
            padding: 30px;
            border-radius: 20px;
            margin: 25px 0;
            border-left: 5px solid #4CAF50;
        }
        .study-dashboard {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
            margin: 25px 0;
        }
        .progress-panel {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
        }
        .current-lesson {
            background: linear-gradient(45deg, #2196F3, #1976D2);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
        }
        .problem-area {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .form-group {
            margin: 20px 0;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2e7d32;
        }
        .form-group select, .form-group input, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            margin: 5px;
        }
        .btn-primary { background: #4CAF50; color: white; }
        .btn-secondary { background: #2196F3; color: white; }
        .btn:hover { transform: translateY(-2px); }
        
        @media (max-width: 768px) {
            .study-dashboard { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🌸 さくら先生の個別カリキュラム学習システム</h1>
            <p>文科省指導要領準拠・高校入試対応の完全個別指導</p>
        </div>

        <!-- カリキュラム設定セクション -->
        <div class="curriculum-setup">
            <h2>📋 あなた専用カリキュラムを作成しましょう</h2>
            
            <div class="form-group">
                <label for="studentGrade">現在の学年</label>
                <select id="studentGrade">
                    <option value="中学1年">中学1年</option>
                    <option value="中学2年">中学2年</option>
                    <option value="中学3年">中学3年</option>
                </select>
            </div>

            <div class="form-group">
                <label for="currentLevel">数学の理解度</label>
                <select id="currentLevel">
                    <option value="30">小学校の内容から不安（偏差値30程度）</option>
                    <option value="40">基礎からしっかり学びたい（偏差値40程度）</option>
                    <option value="50">標準的な問題は解ける（偏差値50程度）</option>
                </select>
            </div>

            <div class="form-group">
                <label for="learningGoal">学習目標</label>
                <select id="learningGoal">
                    <option value="基礎学力向上">まずは基礎をしっかり固めたい</option>
                    <option value="定期テスト対策">定期テストで点数を上げたい</option>
                    <option value="高校受験準備">高校受験に向けて準備したい</option>
                </select>
            </div>

            <div class="form-group">
                <label for="dailyTime">1日の学習時間</label>
                <select id="dailyTime">
                    <option value="20">20分（短時間集中）</option>
                    <option value="30">30分（標準）</option>
                    <option value="45">45分（しっかり学習）</option>
                </select>
            </div>

            <div class="form-group">
                <label for="weakAreas">特に苦手な分野</label>
                <textarea id="weakAreas" rows="3" placeholder="例：分数の計算、方程式、図形など"></textarea>
            </div>

            <button class="btn btn-primary" onclick="createCurriculum()" style="width: 100%; font-size: 18px; padding: 15px;">
                🎯 私専用のカリキュラムを作成する
            </button>

            <div id="curriculumResult" style="margin-top: 30px; display: none;">
                <h3>📅 あなた専用カリキュラム</h3>
                <div id="curriculumDisplay"></div>
            </div>
        </div>

        <!-- 学習ダッシュボード -->
        <div class="study-dashboard" id="studyDashboard" style="display: none;">
            <div class="progress-panel">
                <div class="current-lesson">
                    <h3 id="currentLessonTitle">今日の学習</h3>
                    <p id="currentLessonDesc">カリキュラムを設定してください</p>
                </div>
                
                <div>
                    <h4>📈 学習進捗</h4>
                    <div style="background: #e9ecef; height: 20px; border-radius: 10px; margin: 15px 0;">
                        <div id="progressBar" style="background: linear-gradient(45deg, #4CAF50, #45a049); height: 100%; width: 0%; border-radius: 10px; transition: width 0.3s;"></div>
                    </div>
                    <p id="progressText">0% 完了</p>
                </div>

                <div style="margin-top: 20px;">
                    <h4>🏆 学習統計</h4>
                    <p>今週の問題数: <span id="weeklyProblems">0</span>問</p>
                    <p>正解率: <span id="accuracyRate">0</span>%</p>
                    <p>学習時間: <span id="studyTime">0</span>分</p>
                </div>
            </div>

            <div class="problem-area">
                <div id="problemContainer">
                    <div style="text-align: center; padding: 40px;">
                        <h3>📚 学習準備完了</h3>
                        <p>カリキュラムに沿って問題を出題します</p>
                        <button class="btn btn-primary" onclick="startLearning()">📝 学習を開始</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- バーチャルヒューマンセクション -->
        <div class="avatar-container">
            <h3>🤖 さくら先生と学習相談</h3>
            <p>カリキュラムや問題について音声で相談してください</p>
            
            <!-- HeyGenの埋め込みコードをここに貼り付け -->
            <iframe 
                src="ここにHeyGenから取得したURLを貼り付け" 
                width="800" 
                height="600" 
                frameborder="0" 
                allow="microphone; camera; autoplay; fullscreen"
                allowfullscreen>
            </iframe>
        </div>

        <!-- 画像アップロードセクション（既存機能を統合） -->
        <div class="upload-section">
            <h3>📸 プリント解析機能</h3>
            <p>学校のプリントを撮影してアップロードすると、カリキュラムに組み込んで指導します</p>
            <!-- 既存の画像アップロード機能をここに統合 -->
        </div>
    </div>

    <script>
        let currentCurriculum = null;
        let currentWeek = 1;
        let currentProblem = null;
        let learningProgress = {
            totalProblems: 0,
            correctAnswers: 0,
            weeklyTime: 0,
            currentUnit: ''
        };

        async function createCurriculum() {
            const studentProfile = {
                grade: document.getElementById('studentGrade').value,
                level: document.getElementById('currentLevel').value,
                weakAreas: document.getElementById('weakAreas').value.split('、').filter(area => area.trim())
            };

            const learningGoals = {
                target: document.getElementById('learningGoal').value,
                dailyTime: parseInt(document.getElementById('dailyTime').value)
            };

            try {
                showLoading('カリキュラムを作成中...');
                
                const response = await fetch('/api/curriculum-generator', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        studentProfile: studentProfile,
                        learningGoals: learningGoals,
                        timeframe: 12
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    currentCurriculum = result.curriculum;
                    displayCurriculum(result.curriculum);
                    document.getElementById('curriculumResult').style.display = 'block';
                    document.getElementById('studyDashboard').style.display = 'grid';
                    
                    // 最初の週の設定
                    if (result.curriculum.weekly_schedule && result.curriculum.weekly_schedule.length > 0) {
                        const firstWeek = result.curriculum.weekly_schedule[0];
                        document.getElementById('currentLessonTitle').textContent = `第${firstWeek.week}週: ${firstWeek.unit}`;
                        document.getElementById('currentLessonDesc').textContent = firstWeek.learning_objectives.join('、');
                        learningProgress.currentUnit = firstWeek.unit;
                    }
                    
                    alert('🎉 あなた専用のカリキュラムが完成しました！');
                } else {
                    throw new Error(result.message || 'カリキュラム作成に失敗しました');
                }
            } catch (error) {
                console.error('カリキュラム作成エラー:', error);
                alert('カリキュラムの作成中にエラーが発生しました。もう一度試してください。');
            } finally {
                hideLoading();
            }
        }

        function displayCurriculum(curriculum) {
            const display = document.getElementById('curriculumDisplay');
            let html = `
                <div style="background: white; padding: 20px; border-radius: 15px; margin: 15px 0;">
                    <h4>🎯 ${curriculum.curriculum_title}</h4>
                    <p><strong>到達目標:</strong> ${curriculum.overall_goal}</p>
                    <p><strong>指導方針:</strong> ${curriculum.learning_approach}</p>
                </div>
            `;

            if (curriculum.weekly_schedule) {
                html += '<div style="margin-top: 20px;"><h4>📅 学習スケジュール（最初の4週間）</h4>';
                curriculum.weekly_schedule.slice(0, 4).forEach(week => {
                    html += `
                        <div style="background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 10px; border-left: 4px solid #4CAF50;">
                            <h5>第${week.week}週: ${week.unit}</h5>
                            <p><strong>学習目標:</strong> ${week.learning_objectives.join('、')}</p>
                            <p><strong>評価方法:</strong> ${week.assessment_method}</p>
                        </div>
                    `;
                });
                html += '</div>';
            }

            if (curriculum.motivation_message) {
                html += `
                    <div style="background: linear-gradient(45deg, #4CAF50, #45a049); color: white; padding: 20px; border-radius: 15px; margin: 20px 0; text-align: center;">
                        <h4>🌸 さくら先生からのメッセージ</h4>
                        <p>${curriculum.motivation_message}</p>
                    </div>
                `;
            }

            display.innerHTML = html;
        }

        async function startLearning() {
            if (!currentCurriculum || !learningProgress.currentUnit) {
                alert('まずカリキュラムを設定してください');
                return;
            }

            try {
                showLoading('問題を準備中...');
                
                const response = await fetch('/api/problem-generator', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        unit: learningProgress.currentUnit,
                        difficulty: '基礎',
                        problemType: '計算問題',
                        examPrep: document.getElementById('learningGoal').value.includes('受験')
                    })
                });

                const result = await response.json();
                
                if (result.success && result.problems.problems) {
                    currentProblem = result.problems.problems[0];
                    displayProblem(currentProblem);
                } else {
                    throw new Error('問題の生成に失敗しました');
                }
            } catch (error) {
                console.error('問題生成エラー:', error);
                alert('問題の生成中にエラーが発生しました。');
            } finally {
                hideLoading();
            }
        }

        function displayProblem(problem) {
            const container = document.getElementById('problemContainer');
            container.innerHTML = `
                <div>
                    <h4>📝 ${problem.unit} - ${problem.problem_type}</h4>
                    <div style="font-size: 18px; line-height: 1.6; margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                        ${problem.question}
                    </div>
                    
                    <input type="text" id="answerInput" placeholder="答えを入力してください" 
                           style="width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 10px; font-size: 16px; margin: 15px 0;">
                    
                    <div id="hintSection" style="background: #fff3cd; padding: 15px; border-radius: 10px; margin: 15px 0; display: none;">
                        <h5>💡 ヒント</h5>
                        <p id="hintText"></p>
                    </div>
                    
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 20px;">
                        <button class="btn btn-primary" onclick="checkAnswer()">✓ 答えを確認</button>
                        <button class="btn btn-secondary" onclick="showHint()">💡 ヒントを見る</button>
                        <button class="btn" style="background: #ff9800; color: white;" onclick="askTeacher()">🤖 先生に質問</button>
                        <button class="btn" style="background: #9C27B0; color: white;" onclick="nextProblem()">⏭ 次の問題</button>
                    </div>
                    
                    <div style="margin-top: 15px; padding: 10px; background: #e8f5e8; border-radius: 8px; font-size: 14px;">
                        <p><strong>難易度:</strong> ${problem.difficulty_level} | <strong>目安時間:</strong> ${problem.estimated_time}分</p>
                        <p><strong>指導要領対応:</strong> ${problem.curriculum_alignment}</p>
                        ${problem.exam_relevance ? `<p><strong>入試関連度:</strong> ${problem.exam_relevance}</p>` : ''}
                    </div>
                </div>
            `;
        }

        let hintLevel = 0;
        function showHint() {
            if (!currentProblem || !currentProblem.hints) return;
            
            const hintSection = document.getElementById('hintSection');
            const hintText = document.getElementById('hintText');
            
            if (hintLevel < currentProblem.hints.length) {
                hintText.textContent = currentProblem.hints[hintLevel].text;
                hintSection.style.display = 'block';
                hintLevel++;
            } else {
                hintText.textContent = '全てのヒントを表示しました。頑張って解いてみてね！';
            }
        }

        function checkAnswer() {
            if (!currentProblem) return;
            
            const studentAnswer = document.getElementById('answerInput').value.trim();
            if (!studentAnswer) {
                alert('答えを入力してください');
                return;
            }

            // 簡易評価（実際はバックエンドで詳細評価）
            const isCorrect = studentAnswer.toLowerCase() === currentProblem.correct_answer.toLowerCase();
            
            learningProgress.totalProblems++;
            if (isCorrect) {
                learningProgress.correctAnswers++;
                alert(`🎉 正解です！${currentProblem.encouragement}`);
                updateProgress();
                setTimeout(() => nextProblem(), 2000);
            } else {
                alert(`📝 惜しい！${currentProblem.encouragement}\n\nヒントを参考に再挑戦してみてください。`);
            }
        }

        function askTeacher() {
            if (!currentProblem) return;
            
            const questionText = `この問題について教えてください：\n\n${currentProblem.question}\n\n段階的にヒントで導いてください。答えは教えないでお願いします。`;
            
            navigator.clipboard.writeText(questionText).then(() => {
                alert('質問内容をコピーしました！下のさくら先生に貼り付けて質問してください。');
            }).catch(() => {
                prompt('以下の内容をコピーしてさくら先生に質問してください:', questionText);
            });
        }

        function nextProblem() {
            startLearning(); // 新しい問題を生成
            hintLevel = 0; // ヒントレベルをリセット
        }

        function updateProgress() {
            const accuracy = learningProgress.totalProblems > 0 ? 
                Math.round((learningProgress.correctAnswers / learningProgress.totalProblems) * 100) : 0;
            
            document.getElementById('weeklyProblems').textContent = learningProgress.totalProblems;
            document.getElementById('accuracyRate').textContent = accuracy;
            document.getElementById('progressText').textContent = `${accuracy}% 完了`;
            document.getElementById('progressBar').style.width = accuracy + '%';
        }

        function showLoading(message) {
            console.log('Loading:', message);
            // 実際のローディング表示を実装
        }

        function hideLoading() {
            console.log('Loading complete');
        }

        // 初期化
        window.addEventListener('load', function() {
            console.log('さくら先生の個別カリキュラムシステムが読み込まれました');
        });
    </script>
</body>
</html>
